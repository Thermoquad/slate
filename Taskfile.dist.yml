# SPDX-License-Identifier: GPL-2.0-or-later
# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: "3"

env:
  FIRMWARE_IMG: build/zephyr/zephyr.hex
  RP_CFG: ../../tools/installs/openocd/share/openocd/scripts/target/rp2350.cfg
  BOARD: rpi_pico2/rp2350a/m33
  PROBE_USB_ID: 2e8a:000c
  OCD_CFG: cmsis-dap.cfg

tasks:
  flash-firmware:
    desc: Flash the Helios firmware to an RP235x
    deps:
      - task: build-firmware
      - task: setup-flash-config
    preconditions:
      - test -f $FIRMWARE_IMG
    cmds:
      - ../../bin/openocd -f $OCD_CFG -f $RP_CFG -c "program $FIRMWARE_IMG verify reset exit"

  reset-pico:
    desc: Reset the RP235x connected to the Helios debug probe
    deps:
      - task: setup-flash-config
    preconditions:
      - test -f $OCD_CFG
    cmds:
      - ../../bin/openocd -f $OCD_CFG -f $RP_CFG -c "reset exit"

  menuconfig:
    desc: Start menuconfig to configure the software in Zephyr
    cmds:
      - west build -t menuconfig
      - task: build-firmware

  config-diff:
    desc: Display Zephyr's Kconfig diff
    ignore_error: true
    cmd: diff --color build/zephyr/.config.old build/zephyr/.config

  auto-build:
    desc: Build the Helios firmware automatically when files are saved
    watch: true
    sources:
      - src/**
      - include/**
      - boards/**
      - prj.conf
      - app.overlay
      - CMakeLists.txt
    cmd: west build

  auto-flash:
    desc: Build the Helios firmware automatically when files are saved
    watch: true
    sources:
      - src/**
      - include/**
      - boards/**
      - prj.conf
      - app.overlay
      - CMakeLists.txt
    cmds:
      - west build
      - ../../bin/openocd -f $OCD_CFG -f $RP_CFG -c "program $FIRMWARE_IMG verify reset exit"

  build-firmware:
    desc: Build the Helios firmware
    cmd: west build

  rebuild-firmware:
    desc: Rebuild the Helios firmware
    cmd: west build -p always

  setup-flash-config:
    desc: Create an opendocd config that will flash firmware via a specific Pico debug probe
    interactive: true
    env:
      PROBE_COUNT:
        sh: lsusb -d $PROBE_USB_ID -v | grep iSerial | awk '{print $3}' | wc -l
      PROBE_SERIALS:
        sh: lsusb -d $PROBE_USB_ID -v | grep iSerial | awk '{print $3}'
    status:
      - test -f cmsis-dap.cfg
    cmds:
      - "{{ if int .PROBE_COUNT | gt 1 }}gum confirm 'There is more than one Pico probe connected, do you know the serial number of the probe you want to configure?'{{ end }}"
      - echo "adapter driver cmsis-dap" > $OCD_CFG
      - echo -n "adapter serial " >> $OCD_CFG
      - echo "$PROBE_SERIALS" | gum choose --select-if-one --header "Select the Pico probe you'd like to use with Helios:" >> $OCD_CFG
      - echo "adapter speed 5000" >> $OCD_CFG

  serial-terminal:
    desc: Starts minicom
    interactive: true
    env:
      SERIAL_PORT:
        sh: ls -l /dev/ttyACM* | awk '{print $10}' | gum choose --header "Pick the serial port to connect to:"
    cmd: minicom --baudrate 115200 --device $SERIAL_PORT

  firmware-stats:
    desc: Display firmware memory usage statistics
    preconditions:
      - test -f build/zephyr/zephyr.elf
      - test -f build/zephyr/zephyr.map
    silent: true
    cmds:
      - |
        echo "Memory region         Used Size  Region Size  %age Used"

        # Get section sizes from ELF
        SIZE_OUTPUT=$(../../tools/zephyr-sdk-0.17.4/arm-zephyr-eabi/bin/arm-zephyr-eabi-size build/zephyr/zephyr.elf)
        TEXT=$(echo "$SIZE_OUTPUT" | awk 'NR==2 {print $1}')
        DATA=$(echo "$SIZE_OUTPUT" | awk 'NR==2 {print $2}')
        BSS=$(echo "$SIZE_OUTPUT" | awk 'NR==2 {print $3}')

        # Calculate used sizes
        FLASH_USED=$((TEXT + DATA))
        RAM_USED=$((DATA + BSS))

        # Get memory region sizes from map file
        FLASH_SIZE=$(grep "^FLASH" build/zephyr/zephyr.map | awk '{print strtonum($3)}')
        RAM_SIZE=$(grep "^RAM" build/zephyr/zephyr.map | awk '{print strtonum($3)}')
        IDT_SIZE=$(grep "^IDT_LIST" build/zephyr/zephyr.map | awk '{print strtonum($3)}')

        # Calculate percentages
        FLASH_PCT=$(awk "BEGIN {printf \"%.2f\", ($FLASH_USED / $FLASH_SIZE) * 100}")
        RAM_PCT=$(awk "BEGIN {printf \"%.2f\", ($RAM_USED / $RAM_SIZE) * 100}")

        # Format output
        printf "%15s: %12s %13s %11s\n" "FLASH" "$FLASH_USED B" "4 MB" "$FLASH_PCT%"
        printf "%15s: %12s %13s %11s\n" "RAM" "$RAM_USED B" "520 KB" "$RAM_PCT%"
        printf "%15s: %12s %13s %11s\n" "IDT_LIST" "0 B" "32 KB" "0.00%"
